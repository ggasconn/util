#!/bin/bash

if [ $# -eq 0 ]
then
  printf "\n\nUso:\n\t$0 veces direccion...\n\n"
  exit 1
fi

ROUTER_IP=172.20.254.100
USER=xxxxx
PASS=yyyyy

NUM=$#
ERR=0
CNT=0
VECES=$1

shift

while true 
do

  if [ $VECES -le 0 ]
  then
    break
  else
    let VECES=VECES-1
  fi 

  for TEST in $*
  do
    let CNT=CNT+1
    ping -c 1 $TEST
    if [ $? -ne 0 ]
    then
      let ERR=ERR+1
    fi 
  done    

done

printf "\n\nErrores: $ERR de $CNT\n"

if [ $ERR -eq $CNT ]
then
  #Registrar el suceso y reiniciar el modem
  echo "$0: ADSL RESET. Errores=$ERR contactando con $*"
  logger "$0: ADSL RESET. Errores=$ERR contactando con $*"
  (sleep 1; printf "$USER\r"; sleep 1; printf "$PASS\r"; sleep 1; echo reboot;     sleep 1; echo Yes) | telnet $ROUTER_IP 
  #reiniciar fetchnews
  sleep 120
  rm -f /var/lock/news/fetchnews.lck
  fetchnews -vvv
else
  echo "$0: ADSL OK. Errores=$ERR"
  logger "$0: ADSL OK. Errores=$ERR"
fi

