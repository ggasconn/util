#!/bin/bash

#zfs.destroy.old.snapshots

if [ $# -lt 3 -o $# -gt 4 ]
then
  printf "\n\nUsage:\n\t$0 src-dataset match-string num-keep [-r]\n\n\n"
  exit 1
fi

N=$3
let "N++"

echo zfs list -t snapshot -H -o name -S creation -d 1 "${1}" \| egrep "${2}" \| tail -n +$N \| xargs --no-run-if-empty -n 1 zfs destroy "${4}"
zfs list -t snapshot -H -o name -S creation -d 1 "${1}" | egrep "${2}" | tail -n +$N | xargs --no-run-if-empty -n 1 zfs destroy ${4}
